(()=>{"use strict";var e={n:r=>{var o=r&&r.__esModule?()=>r.default:()=>r;return e.d(o,{a:o}),o},d:(r,o)=>{for(var s in o)e.o(o,s)&&!e.o(r,s)&&Object.defineProperty(r,s,{enumerable:!0,get:o[s]})},o:(e,r)=>Object.prototype.hasOwnProperty.call(e,r)};const r=require("ws");var o=e.n(r);const s=require("path");var n=e.n(s);const t=require("dotenv");var i=e.n(t);const c=require("cors");var a=e.n(c);const u=require("events");e.n(u)().EventEmitter.prototype._maxListeners=100;const d=n().join(process.cwd(),"conf",".env");i().config({path:d});const p=process.env.DOMAIN_CONNECTION,v=p?p.split(","):[],l=require("express");var m=e.n(l);const O=require("http");var g=e.n(O);const S=require("redis");var q=e.n(S);let f={host:process.env.REDIS_HOST||"redis-15502.c283.us-east-1-4.ec2.cloud.redislabs.com",port:process.env.REDIS_PORT||"15502",password:process.env.REDIS_PASS||Fdc6LmJM7r77uRqDdoUjfgKodTuAwPVP};const N=q().createClient(f),b=N.duplicate(),h=require("uuid"),w=m()(),E=process.env.PORT||7071;w.use(a()(((e,r)=>{let o;o=-1!==v.indexOf(e.header("Origin"))?{origin:!0}:{origin:!1},r(null,o)})));const P=g().createServer(w),y=new(o().Server)({server:P}),D="ws:messages";N.on("message",((e,r)=>{e===D&&y.clients.forEach((e=>{const s=JSON.parse(r);e.readyState===o().OPEN&&((e={},r={})=>!!(e&&e.id&&e.room)&&!!(r&&r.id&&r.room)&&e.id!==r.id&&e.room===r.room)(s,e)&&e.send(r)}))})),y.getUniqueID=function(){return(0,h.v4)()},y.on("connection",((e,r)=>{const o=y.getUniqueID();e.id=o;const s=r.url;e.room=s,console.log(`***** New connection ${o} & room is ${s} *****`),e.on("message",(r=>{let s=JSON.parse(r);s={...s,id:o,room:e.room},"broadcast"===s.type&&b.publish(D,JSON.stringify(s))}))})),N.subscribe(D),P.listen(E,(()=>{console.log(`Server started on port ${E}`)}))})();