(()=>{"use strict";var e={n:r=>{var o=r&&r.__esModule?()=>r.default:()=>r;return e.d(o,{a:o}),o},d:(r,o)=>{for(var n in o)e.o(o,n)&&!e.o(r,n)&&Object.defineProperty(r,n,{enumerable:!0,get:o[n]})},o:(e,r)=>Object.prototype.hasOwnProperty.call(e,r)};const r=require("ws");var o=e.n(r);const n=require("path");var s=e.n(n);const t=require("dotenv");var c=e.n(t);const i=require("cors");var a=e.n(i);const d=require("events");e.n(d)().EventEmitter.prototype._maxListeners=100;const u=s().join(process.cwd(),"conf",".env");c().config({path:u});const l=process.env.DOMAIN_CONNECTION,p=l?l.split(","):[],v=require("express");var m=e.n(v);const g=require("http");var O=e.n(g);const q=require("redis");var S=e.n(q);let f={host:process.env.REDIS_HOST||"redis-15502.c283.us-east-1-4.ec2.cloud.redislabs.com",port:process.env.REDIS_PORT||"15502",password:process.env.REDIS_PASS||Fdc6LmJM7r77uRqDdoUjfgKodTuAwPVP};const y=S().createClient(f),b=y.duplicate(),h=require("uuid"),w=require("body-parser");var N=e.n(w);const E=m()(),P=process.env.PORT||7071;E.use(a()(((e,r)=>{let o;o=-1!==p.indexOf(e.header("Origin"))?{origin:!0}:{origin:!1},r(null,o)}))),E.use(N().json()),E.use(N().urlencoded({extended:!0}));const D=O().createServer(E),I=new(o().Server)({server:D}),_="ws:messages";y.on("message",((e,r)=>{e===_&&I.clients.forEach((e=>{const n=JSON.parse(r);e.readyState===o().OPEN&&((e={},r={})=>!!(e&&e.id&&e.room)&&!!(r&&r.id&&r.room)&&e.id!==r.id&&e.room===r.room)(n,e)&&e.send(r)}))})),I.getUniqueID=function(){return(0,h.v4)()},I.on("connection",((e,r)=>{const o=I.getUniqueID();e.id=o;const n=r.url;e.room=n,console.log(`***** New connection ${o} & room is ${n} *****`),e.on("message",(r=>{let n=JSON.parse(r);n={...n,id:o,room:e.room},"broadcast"===n.type&&b.publish(_,JSON.stringify(n))}))})),y.subscribe(_),E.post("/notify-download",((e,r)=>{const o=e.body,{hookUrl:n}=e.query;return console.log(o,n),r.json({data:o})})),D.listen(P,(()=>{console.log(`Server started on port ${P}`)}))})();