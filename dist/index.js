(()=>{"use strict";var e={n:r=>{var s=r&&r.__esModule?()=>r.default:()=>r;return e.d(s,{a:s}),s},d:(r,s)=>{for(var n in s)e.o(s,n)&&!e.o(r,n)&&Object.defineProperty(r,n,{enumerable:!0,get:s[n]})},o:(e,r)=>Object.prototype.hasOwnProperty.call(e,r)};const r=require("ws");var s=e.n(r);const n=require("path");var o=e.n(n);const t=require("dotenv");var c=e.n(t);const i=require("cors");var a=e.n(i);const p=require("events");e.n(p)().EventEmitter.prototype._maxListeners=100;const d=o().join(process.cwd(),"conf",".env");c().config({path:d});const u=process.env.DOMAIN_CONNECTION,v=u?u.split(","):[],l=require("express");var O=e.n(l);const g=require("http");var S=e.n(g);const f=require("redis");var q=e.n(f);let y={host:process.env.REDIS_HOST||"redis-15502.c283.us-east-1-4.ec2.cloud.redislabs.com",port:process.env.REDIS_PORT||"15502",password:process.env.REDIS_PASS||Fdc6LmJM7r77uRqDdoUjfgKodTuAwPVP};const b=q().createClient(y),h=b.duplicate(),m=O()(),w=process.env.PORT||7071;m.use(a()(((e,r)=>{let s;s=-1!==v.indexOf(e.header("Origin"))?{origin:!0}:{origin:!1},r(null,s)})));const E=S().createServer(m),N=new(s().Server)({server:E}),P="ws:messages";b.on("message",((e,r)=>{e===P&&N.clients.forEach((e=>{e.readyState===s().OPEN&&e.send(r)}))})),N.on("connection",(e=>{console.log("new connection"),e.on("message",(r=>{const s=JSON.parse(r);"get-users"===s.type&&e.send(JSON.stringify(s)),"broadcast"===s.type&&h.publish(P,JSON.stringify(s))}))})),b.subscribe(P),E.listen(w,(()=>{console.log(`Server started on port ${w}`)}))})();